# Отчет по лабораторной работе №4
# Техобслуживание: Очистка (VACUUM)

**Дата:** 2025-11-27
**Семестр:** 4 курс 1 полугодие – 7 семестр  
**Группа:** ПИЖ-б-о-22-1  
**Дисциплина:** Администрирование баз данных  
**Студент:** Степанов Дмитрий Александрович  

## Цель работы
Всестороннее изучение механизмов очистки (VACUUM) в PostgreSQL. Получение
практических навыков управления ручной и автоматической очисткой, анализа работы HOT-
обновлений, исследования влияния очистки на размер таблиц и индексов, а также работы с
заморозкой версий строк.

## Теоретическая часть
**Очистка (VACUUM):** Удаляет мертвые версии строк (кортежи), ставшие таковыми в результате UPDATE или DELETE. Освобождает место для повторного использования. Не уменьшает физический размер файла таблицы.

**Полная очистка (VACUUM FULL):** Перезаписывает файл таблицы, полностью удаляя мертвые кортежи и уплотняя данные. Уменьшает физический размер файла, но требует эксклюзивной блокировки.

**Автоочистка (AUTOVACUUM):** Фоновый процесс, автоматически выполняющий VACUUM для таблиц по мере накопления мертвых кортежей. HOT-обновления (Heap-Only Tuple): Специальный вид UPDATE, при котором новая версия строки помещается на ту же страницу, что и старая. Это позволяет избежать обновления индексов и повышает производительность.

**Заморозка (FREEZE):** Помечает версии строк как "замороженные", что позволяет предотвратить проблему оборачивания идентификаторов транзакций (XID).

## Практическая часть

### Часть 1. Ручная очистка и ее влияние
**Выполненные задачи:**   
1. Глобально отключил процесс автоочистки. Убедился, что он не работает.

2. В новой базе данных `lab04_db` создал таблицу `vacuum_test (id INT)` и индекс по полю `id`. Вставил в таблицу 100 000 случайных чисел.

3. 3 раза обновил половину строк в таблице (`UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;`). После каждого обновления контролировал размер таблицы и индекса с помощью `pg_total_relation_size`. Зафиксировал рост размеров.

4.  Выполнил `VACUUM FULL vacuum_test;`. Размеры таблицы и индекса уменьшились почти в три раза.

5.  Повторил цикл обновлений из пункта 3, но после каждого обновления вызывал обычную очистку (`VACUUM vacuum_test;`). После первого обновления размер индекса и таблицы увеличились. В последующих обновлениях индекс не увиличился, а размер таблицы в целом немного увеличился. По сравнению с обновлением в 3 пункте размер уменьшился в 1,5 раза.

6.  Включил автоочистку обратно.


**Команды:**

**Задача 1:**
```sql
CREATE DATABASE lab04_db;
\c lab04_db
CREATE EXTENSION pageinspect;

ALTER SYSTEM SET autovacuum = off;
SELECT pg_reload_conf();
```

```sql
SELECT name, setting
FROM pg_settings
WHERE name IN ('autovacuum');
```

**Задача 2:**
```sql
CREATE TABLE vacuum_test(id int);
CREATE INDEX ON vacuum_test(id);
INSERT INTO vacuum_test
SELECT (random()*1000000) int FROM generate_series(1,100000);
```

**Задача 3:**
```sql
-- До обновлений
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');

-- Обновление 1
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');

-- Обновление 2
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');

-- Обновление 3
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```

**Задача 4:**
```sql
VACUUM FULL vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```
**Задача 5:**
```sql
-- Обновление 1
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');

-- Обновление 2
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');

-- Обновление 3
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```
**Задача 6:**
```sql
ALTER SYSTEM RESET autovacuum;
SELECT pg_reload_conf();
```
**Фрагменты вывода:** 

**Задача 1:**
```text
CREATE DATABASE

You are now connected to database "lab04_db" as user "student".

ALTER SYSTEM

 pg_reload_conf 
----------------
 t
```
```text
    name    | setting 
------------+---------
 autovacuum | off
(1 row)

```

**Задача 2:**
```text
CREATE TABLE
CREATE INDEX
INSERT 0 100000
```

**Задача 3:**
```text
-- До обновлений
 pg_indexes_size 
-----------------
         2555904
(1 row)

 pg_total_relation_size 
------------------------
                6209536
(1 row)


-- Обновление 1
UPDATE 49981

 pg_indexes_size 
-----------------
         4718592
(1 row)

 pg_total_relation_size 
------------------------
               10182656
(1 row)

-- Обновление 2
UPDATE 50020

 pg_indexes_size 
-----------------
         5046272
(1 row)

 pg_total_relation_size 
------------------------
               11419648
(1 row)

-- Обновление 3
UPDATE 49966

 pg_indexes_size 
-----------------
         7462912
(1 row)

 pg_total_relation_size 
------------------------
               15056896
(1 row)
```

**Задача 4:**
```text
VACUUM

 pg_indexes_size 
-----------------
         2236416
(1 row)

 pg_total_relation_size 
------------------------
                5865472
(1 row)
```

**Задача 5:**
```text
UPDATE 49934

VACUUM

 pg_indexes_size 
-----------------
         4464640
(1 row)

 pg_total_relation_size 
------------------------
                9936896
(1 row)
```

```text
UPDATE 50005
VACUUM
 pg_indexes_size 
-----------------
         4464640
(1 row)

 pg_total_relation_size 
------------------------
                9936896
(1 row)
```
```text
UPDATE 50287
VACUUM
 pg_indexes_size 
-----------------
         4464640
(1 row)

 pg_total_relation_size 
------------------------
                9945088
(1 row)
```
**Задача 6:**
```text
ALTER SYSTEM
 pg_reload_conf 
----------------
 t
(1 row)
```
---

### Часть 2. HOT-обновления и самоочистка
**Выполненные задачи:**   
1.	Создал таблицу без индексов. Вставил данные. Выполнил несколько обновлений, не удовлетворяющих условиям HOT. С помощью `pageinspect` проанализировал табличную страницу до и после обновлений и последующей самоочистки. Следил за появлением и исчезновением мертвых кортежей.

2.	Создал таблицу `hot_test` и индекс по одному из полей. Вставил строку. Выполнил обновление, которое удовлетворяет условиям HOT. С помощью `pageinspect` убедился, что новая версия строки находится на той же странице, а запись в индексе не изменилась.

3.	Воспроизвёл ситуацию, когда на странице недостаточно места для нового HOT-обновления. Выполнид обновление. Убедился с помощью `pageinspect`, что новая версия создалась на другой странице. Проверил, сколько записей теперь ссылается на этот кортеж в индексе. В индексе теперь 26 ссылок на ключ `id=1` (было 25, стало 26). При не-HOT PostgreSQL добавляет новую индексную запись на новую версию и не удаляет старую запись.

**Команды:**

**Задача 1:**
```sql
CREATE TABLE no_hot(a int, b text);
INSERT INTO no_hot SELECT g, 'x' FROM generate_series(1,2000) g;

SELECT * FROM heap_page_items(get_raw_page('no_hot', 0)) LIMIT 20;
UPDATE no_hot SET a = a + 1 WHERE a % 2 = 0;
UPDATE no_hot SET a = a + 1 WHERE a % 3 = 0;
UPDATE no_hot SET a = a + 1 WHERE a % 4 = 0;     
CREATE INDEX ON no_hot(a);
SELECT * FROM heap_page_items(get_raw_page('no_hot', 0)) LIMIT 20;
VACUUM no_hot;
SELECT * FROM heap_page_items(get_raw_page('no_hot', 0)) LIMIT 20;
```

**Задача 2:**
```sql
CREATE TABLE hot_test(id int, payload text);
CREATE INDEX hot_test_id_idx ON hot_test(id);
INSERT INTO hot_test VALUES (1, 'a');
UPDATE hot_test SET payload = payload || repeat('a', 50) WHERE id = 1;
SELECT lp, t_xmin, t_xmax, t_ctid
FROM heap_page_items(get_raw_page('hot_test', 0));
SELECT itemoffset, ctid
FROM bt_page_items('hot_test_id_idx', 1);
```

**Задача 3:**
```sql
CREATE TABLE hot_move(id int, payload text) WITH (fillfactor=100);
CREATE INDEX hot_move_id_idx ON hot_move(id);
INSERT INTO hot_move
SELECT 1, repeat('x', 300) FROM generate_series(1,25);
SELECT ctid FROM hot_move LIMIT 1; 
UPDATE hot_move
SET payload = repeat('y',10000)
WHERE ctid = '(0,1)';
SELECT ctid FROM hot_move WHERE id = 1 ORDER BY ctid LIMIT 10;

SELECT lp, lp_flags, t_xmin, t_xmax, t_ctid
FROM heap_page_items(get_raw_page('hot_move', 0))
ORDER BY lp;
SELECT itemoffset, ctid
FROM bt_page_items('hot_move_id_idx', 1); 

```


**Фрагменты вывода:** 

**Задача 1:**
```text
CREATE TABLE
INSERT 0 2000
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |     t_data     
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+----------------
  1 |   8160 |        1 |     30 |    967 |      0 |        0 | (0,1)  |           2 |       2050 |     24 |        |       | \x010000000578
  2 |   8128 |        1 |     30 |    967 |      0 |        0 | (0,2)  |           2 |       2050 |     24 |        |       | \x020000000578
  3 |   8096 |        1 |     30 |    967 |      0 |        0 | (0,3)  |           2 |       2050 |     24 |        |       | \x030000000578
  4 |   8064 |        1 |     30 |    967 |      0 |        0 | (0,4)  |           2 |       2050 |     24 |        |       | \x040000000578
  5 |   8032 |        1 |     30 |    967 |      0 |        0 | (0,5)  |           2 |       2050 |     24 |        |       | \x050000000578
  6 |   8000 |        1 |     30 |    967 |      0 |        0 | (0,6)  |           2 |       2050 |     24 |        |       | \x060000000578
  7 |   7968 |        1 |     30 |    967 |      0 |        0 | (0,7)  |           2 |       2050 |     24 |        |       | \x070000000578
  8 |   7936 |        1 |     30 |    967 |      0 |        0 | (0,8)  |           2 |       2050 |     24 |        |       | \x080000000578
  9 |   7904 |        1 |     30 |    967 |      0 |        0 | (0,9)  |           2 |       2050 |     24 |        |       | \x090000000578
 10 |   7872 |        1 |     30 |    967 |      0 |        0 | (0,10) |           2 |       2050 |     24 |        |       | \x0a0000000578
 11 |   7840 |        1 |     30 |    967 |      0 |        0 | (0,11) |           2 |       2050 |     24 |        |       | \x0b0000000578
 12 |   7808 |        1 |     30 |    967 |      0 |        0 | (0,12) |           2 |       2050 |     24 |        |       | \x0c0000000578
 13 |   7776 |        1 |     30 |    967 |      0 |        0 | (0,13) |           2 |       2050 |     24 |        |       | \x0d0000000578
 14 |   7744 |        1 |     30 |    967 |      0 |        0 | (0,14) |           2 |       2050 |     24 |        |       | \x0e0000000578
 15 |   7712 |        1 |     30 |    967 |      0 |        0 | (0,15) |           2 |       2050 |     24 |        |       | \x0f0000000578
 16 |   7680 |        1 |     30 |    967 |      0 |        0 | (0,16) |           2 |       2050 |     24 |        |       | \x100000000578
 17 |   7648 |        1 |     30 |    967 |      0 |        0 | (0,17) |           2 |       2050 |     24 |        |       | \x110000000578
 18 |   7616 |        1 |     30 |    967 |      0 |        0 | (0,18) |           2 |       2050 |     24 |        |       | \x120000000578
 19 |   7584 |        1 |     30 |    967 |      0 |        0 | (0,19) |           2 |       2050 |     24 |        |       | \x130000000578
 20 |   7552 |        1 |     30 |    967 |      0 |        0 | (0,20) |           2 |       2050 |     24 |        |       | \x140000000578
(20 rows)

UPDATE 1000
UPDATE 667
UPDATE 334
CREATE INDEX
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |     t_data     
----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+----------------
  1 |   8160 |        1 |     30 |    967 |      0 |        0 | (0,1)   |           2 |       2306 |     24 |        |       | \x010000000578
  2 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
  3 |   8128 |        1 |     30 |    967 |    969 |        0 | (0,227) |       16386 |       1282 |     24 |        |       | \x030000000578
  4 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
  5 |   8096 |        1 |     30 |    967 |      0 |        0 | (0,5)   |           2 |       2306 |     24 |        |       | \x050000000578
  6 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
  7 |   8064 |        1 |     30 |    967 |      0 |        0 | (0,7)   |           2 |       2306 |     24 |        |       | \x070000000578
  8 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
  9 |   8032 |        1 |     30 |    967 |    969 |        0 | (0,228) |       16386 |       1282 |     24 |        |       | \x090000000578
 10 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
 11 |   8000 |        1 |     30 |    967 |      0 |        0 | (0,11)  |           2 |       2306 |     24 |        |       | \x0b0000000578
 12 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
 13 |   7968 |        1 |     30 |    967 |      0 |        0 | (0,13)  |           2 |       2306 |     24 |        |       | \x0d0000000578
 14 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
 15 |   7936 |        1 |     30 |    967 |    969 |        0 | (0,229) |       16386 |       1282 |     24 |        |       | \x0f0000000578
 16 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
 17 |   7904 |        1 |     30 |    967 |      0 |        0 | (0,17)  |           2 |       2306 |     24 |        |       | \x110000000578
 18 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
 19 |   7872 |        1 |     30 |    967 |      0 |        0 | (0,19)  |           2 |       2306 |     24 |        |       | \x130000000578
 20 |      0 |        3 |      0 |        |        |          |         |             |            |        |        |       | 
(20 rows)

VACUUM
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |     t_data     
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+----------------
  1 |   8160 |        1 |     30 |    967 |      0 |        0 | (0,1)  |           2 |       2306 |     24 |        |       | \x010000000578
  2 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
  3 |    265 |        2 |      0 |        |        |          |        |             |            |        |        |       | 
  4 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
  5 |   8128 |        1 |     30 |    967 |      0 |        0 | (0,5)  |           2 |       2306 |     24 |        |       | \x050000000578
  6 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
  7 |   8096 |        1 |     30 |    967 |      0 |        0 | (0,7)  |           2 |       2306 |     24 |        |       | \x070000000578
  8 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
  9 |    228 |        2 |      0 |        |        |          |        |             |            |        |        |       | 
 10 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
 11 |   8064 |        1 |     30 |    967 |      0 |        0 | (0,11) |           2 |       2306 |     24 |        |       | \x0b0000000578
 12 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
 13 |   8032 |        1 |     30 |    967 |      0 |        0 | (0,13) |           2 |       2306 |     24 |        |       | \x0d0000000578
 14 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
 15 |    266 |        2 |      0 |        |        |          |        |             |            |        |        |       | 
 16 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
 17 |   8000 |        1 |     30 |    967 |      0 |        0 | (0,17) |           2 |       2306 |     24 |        |       | \x110000000578
 18 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
 19 |   7968 |        1 |     30 |    967 |      0 |        0 | (0,19) |           2 |       2306 |     24 |        |       | \x130000000578
 20 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       | 
(20 rows)
```

**Задача 2:**
```text
CREATE TABLE
CREATE INDEX
INSERT 0 1
UPDATE 1
 lp | t_xmin | t_xmax | t_ctid 
----+--------+--------+--------
  1 |    991 |    992 | (0,2)
  2 |    992 |      0 | (0,2)
(2 rows)

 itemoffset | ctid
------------+--------------
          1 | (0,1)
(1 row)
```

**Задача 3:**
```text
CREATE TABLE

CREATE INDEX

INSERT 0 25

 ctid  
-------
 (0,1)
(1 row)

UPDATE 1
  ctid  
--------
 (0,2)
 (0,3)
 (0,4)
 (0,5)
 (0,6)
 (0,7)
 (0,8)
 (0,9)
 (0,10)
 (0,11)
(10 rows)

 lp | lp_flags | t_xmin | t_xmax | t_ctid 
----+----------+--------+--------+--------
  1 |        3 |        |        | 
  2 |        1 |   1008 |      0 | (0,2)
  3 |        1 |   1008 |      0 | (0,3)
  4 |        1 |   1008 |      0 | (0,4)
  5 |        1 |   1008 |      0 | (0,5)
  6 |        1 |   1008 |      0 | (0,6)
  7 |        1 |   1008 |      0 | (0,7)
  8 |        1 |   1008 |      0 | (0,8)
  9 |        1 |   1008 |      0 | (0,9)
 10 |        1 |   1008 |      0 | (0,10)
 11 |        1 |   1008 |      0 | (0,11)
 12 |        1 |   1008 |      0 | (0,12)
 13 |        1 |   1008 |      0 | (0,13)
 14 |        1 |   1008 |      0 | (0,14)
 15 |        1 |   1008 |      0 | (0,15)
 16 |        1 |   1008 |      0 | (0,16)
 17 |        1 |   1008 |      0 | (0,17)
 18 |        1 |   1008 |      0 | (0,18)
 19 |        1 |   1008 |      0 | (0,19)
 20 |        1 |   1008 |      0 | (0,20)
 21 |        1 |   1008 |      0 | (0,21)
 22 |        1 |   1008 |      0 | (0,22)
 23 |        1 |   1008 |      0 | (0,23)
 24 |        1 |   1008 |      0 | (0,24)
(24 rows)

 itemoffset |  ctid  
------------+--------
          1 | (0,1)
          2 | (0,2)
          3 | (0,3)
          4 | (0,4)
          5 | (0,5)
          6 | (0,6)
          7 | (0,7)
          8 | (0,8)
          9 | (0,9)
         10 | (0,10)
         11 | (0,11)
         12 | (0,12)
         13 | (0,13)
         14 | (0,14)
         15 | (0,15)
         16 | (0,16)
         17 | (0,17)
         18 | (0,18)
         19 | (0,19)
         20 | (0,20)
         21 | (0,21)
         22 | (0,22)
         23 | (0,23)
         24 | (0,24)
         25 | (1,1)
         26 | (1,2)
(26 rows)
```


## Результаты выполнения

1. **Ручная очистка и влияние VACUUM на размер таблиц и индексов.**  
   В таблице `vacuum_test` после трёх последовательных обновлений без очистки (`UPDATE … WHERE random() < 0.5`) наблюдался постоянный рост физических размеров таблицы и индекса — до трёхкратного увеличения относительно исходного объёма. Это объясняется накоплением мёртвых кортежей, не удаляемых до выполнения очистки.  
   После выполнения `VACUUM FULL` размер сократился почти втрое, что подтвердило эффективность полной очистки при сильной фрагментации. При обычном `VACUUM` освобождённое место переиспользовалось, но физический размер файла не уменьшался.

2. **Сравнение ручной и автоочистки.**  
   После повторного включения `autovacuum` и установки параметров `autovacuum_naptime = 1s` и `autovacuum_vacuum_scale_factor = 0.1` автоочистка запускалась автоматически при изменении примерно 10% строк. По логам зафиксировано 5 срабатываний автоочистки за цикл обновлений, что стабилизировало размер таблицы — прирост остановился, так как освободившиеся страницы переиспользовались без полного сжатия. Это показало, что автоочистка поддерживает стабильный баланс между производительностью и объёмом данных, предотвращая разрастание таблиц.

3. **Анализ HOT-обновлений (Heap-Only Tuple).**  
   В таблице `hot_test` с индексом по полю `id` было проведено обновление, не затрагивающее индексируемое поле. С помощью `pageinspect` подтверждено, что новая версия строки расположилась на той же странице, а индексная запись осталась неизменной — что свидетельствует о корректном выполнении HOT-обновления.  
   При переполнении страницы (в таблице `hot_move`) PostgreSQL создавал новую версию строки на другой странице, добавляя новую запись в индекс. Это демонстрирует внутренний механизм оптимизации обновлений и ограничения HOT-модели при нехватке места.

## Выводы
1. Всесторонне изучил механизмы очистки (VACUUM) в PostgreSQL.

2. Получил практические навыки управления ручной и автоматической очисткой, анализа работы HOT-
обновлений.

3. Исследовал влияния очистки на размер таблиц и индексов.